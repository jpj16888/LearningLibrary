[TOC]

参考：

https://www.likecs.com/show-203352845.html

https://www.cndba.cn/hbhe0316/article/4974

https://cdn.modb.pro/db/374579

https://www.likecs.com/show-203352845.html

https://blog.csdn.net/u013365247/article/details/123358070

https://blog.csdn.net/Oracle_zsq/article/details/80566768





### 一、概要及环境

#### 1.概要

```java
dg拥有备份的功能，某些情况下它甚至可以与primary数据库完全一模一样，但是它存在的目的并不仅仅是为了恢复数据，应该说它的存在是为了确保企业数据的高可用性，数据保护以及灾难恢复 ( 注意这个字眼，灾难恢复) 。dg提供全面的服务包括：创建，维护，管理以及监控standby数据库，确保数据安全，管理员可以通过将一些操作转移到standby数据库执行的方式改善数据库性能，构建高可用的企业数据库应用环境。 在Data Gurad 环境中，至少有两个数据库，一个处于Open 状态对外提供服务，这个数据库叫作Primary Database。第二个处于恢复状态，叫作Standby Database。运行时primary Database 对外提供服务，用户在Primary Database 上进行操作，操作被记录在联机日志和归档日志中，这些日志通过网络传递给Standby Database。这个日志会在Standby Database 上重演，从而实现Primary Database 和Standby Database 的数据同步。

Oracle Data Gurad 对这一过程进一步的优化设计，使得日志的传递，恢复工作更加自动化，智能化，并且提供一系列参数和命令简化了DBA工作。 如果是可预见因素需要关闭Primary Database，比如软硬件升级，可以把Standby Database 切换为Primary Database 继续对外服务，这样即减少了服务停止时间，并且数据不会丢失。如果异常原因导致Primary Database 不可用，也可以把Standby Database 强制切换为Primary Database继续对外服务，这时数据损失都和配置的数据保护级别有关系。因此Primary 和Standby 只是一个角色概念，并不固定在某个数据库中。
```



#### 2.环境

##### 2.1主库Primary database

```java
操作系统：Windows Server 2012 R2 Standard
Oracle版本：Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit orcluction
服务器IP：192.168.6.137
服务器名称hostname：WIN-6F72PB8A5M1
实例名SID：orcl
数据库名DB_NAME：orcl
DB_UNIQUE_NAME：primary
```

##### 2.2备库standby database

```java
操作系统：Windows Server 2012 R2 Standard
Oracle版本：Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit orcluction
服务器IP：192.168.6.138
服务器名称hostname：WIN-6F72PB8A5M2
实例名SID：orcl
数据库名DB_NAME：orcl
DB_UNIQUE_NAME：standby
```

##### 2.3相关参数查询

```sql
查看实例名SID、主机名host_name
select instance_name 实例名SID ,host_name 主机名 from V$instance;
查看数据库名DB_NAME：
select name from v$database;
服务名查看:
show parameter service_names;
可以同时查看SID、DB_NAME、SERVICES_NAMES、DB_UNIQUE_NAME
show parameter name; 
show parameter db_file_name_convert
判断DG是否已经安装：
select * from v$option where parameter = 'Oracle Data Guard';
如果是true表示已经安装可以配置，否则需要安装相应组件。

默认db_name和db_unique_name和实例名是一致的，这里是orcl
 需要注意在DG中主库和从库的db_unique_name是不能一致的，需要区分开的。
 这里我们设置主库的db_unique_name为primary，从库为standby
 sql>show parameter db_unique_name
注意虽然默认db_unique_name和db_name是一致的，但是需要显式设置，否则在spfile中没有此参数

```

### 一、主库操作

#### 1、开启归档

```sql
先查看是否开启归档

archive log list;

如果没有启用

shutdown immediate;

startup mount;

alter database archivelog;
检查强制记录日志状态(YEs为强制)：
select name,force_logging from v$database;
设置主库为强制记录日志。
alter database force logging;

alter database open;
```



#### 2、修改系统参数

```sql
--根据实际情况修改db_unique_name

alter system set db_unique_name='primary' scope=spfile;

--standby 是从库的db_unique_name，

alter system set log_archive_config='DG_CONFIG=(primary,standby)';

--设置归档日志传输方式  归档日志存放路径 E:\archivelog

alter system set log_archive_dest_1='LOCATION=E:\archivelog valid_for=(all_logfiles,all_roles) db_unique_name=primary' scope=spfile;

alter system set log_archive_dest_2='SERVICE=standby  lgwr async valid_for=(online_logfile,primary_role) db_unique_name=standby' scope=spfile;

alter system set log_archive_dest_state_1 = ENABLE;

alter system set log_archive_dest_state_2 = ENABLE;

--注意fal_client和fal_server的设置，别设置反了，如果反了可能会导致不会自动同步

alter system set fal_client='primary' scope=spfile;

alter system set fal_server='standby' scope=spfile;

--第一个路径是主库存放的路径，后面是从库的存放路径， 如果多个电脑都不一样，可以允许多个路径

alter system set db_file_name_convert='D:\app\Administrator\oradata\orcl','D:\app\Administrator\oradata\orcl' scope=spfile;

--和上面同样的设置

alter system set log_file_name_convert='D:\app\Administrator\oradata\orcl','D:\app\Administrator\oradata\orcl' scope=spfile;

--归档日志文件命名格式

alter system set log_archive_format='%t_%s_%r.arc' scope=spfile;

alter system set standby_file_management=auto scope=spfile;

--创建日志文件，文件大小和现有的大小需要保持一致，可以通过

--select group#, bytes/1024/1024 from v$log; 查询日志大小

alter database add standby logfile group 4 ('D:\app\Administrator\oradata\orcl\REDO04.LOG') size 300m;

alter database add standby logfile group 5 ('D:\app\Administrator\oradata\orcl\REDO05.LOG') size 300m;

alter database add standby logfile group 6 ('D:\app\Administrator\oradata\orcl\REDO06.LOG') size 300m;

alter database add standby logfile group 7 ('D:\app\Administrator\oradata\orcl\REDO07.LOG') size 300m;

```



#### 3、重启数据库

```sql
shutdown immediate;

startup;
```





#### 4、修改 listener.ora

```sql
# listener.ora Network Configuration File: D:\app\Administrator\product\11.2.0\dbhome_1\network\admin\listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =

  (SID_LIST =

    (SID_DESC =
    
      (GLOBAL_DBNAME = orcl)
    
      (ORACLE_HOME =D:\app\Administrator\product\11.2.0\dbhome_1)
    
      (SID_NAME = orcl)

   )

 )

LISTENER =

  (DESCRIPTION_LIST =

    (DESCRIPTION =
    
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.6.137)(PORT = 1521))
    
    )

  )

ADR_BASE_LISTENER = D:\app\Administrator
```



#### 5、修改tnsnames.ora

```sql
# tnsnames.ora Network Configuration File: D:\app\Administrator\product\11.2.0\dbhome_1\network\admin\tnsnames.ora

primary =

  (DESCRIPTION =

    (ADDRESS_LIST =
    
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.6.137)(PORT = 1521))
    
    )
    
    (CONNECT_DATA =
    
      (SERVICE_NAME = orcl)
    
    )

  )

standby =

  (DESCRIPTION =

    (ADDRESS_LIST =
    
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.6.138)(PORT = 1521))
    
    )
    
    (CONNECT_DATA =
    
      (SERVICE_NAME = orcl)
    
    )

  )

```



### 二、备库standby操作

#### 1、修改系统参数（注意修改红色字体部分内容，根据实际情况修改）

```sql
alter system set db_unique_name='standby' scope=spfile;

alter system set log_archive_config='DG_CONFIG=(primary,standby)';

alter system set log_archive_dest_1='LOCATION=E:\archivelog valid_for=(all_logfiles,all_roles) db_unique_name=standby' scope=spfile;

alter system set log_archive_dest_2='SERVICE=primary  lgwr async valid_for=(online_logfile,primary_role) db_unique_name=primary' scope=spfile;

alter system set log_archive_dest_state_1 = ENABLE;

alter system set log_archive_dest_state_2 = ENABLE;

alter system set fal_client='standby' scope=spfile;

alter system set fal_server='primary' scope=spfile;

alter system set db_file_name_convert='D:\app\Administrator\oradata\orcl','D:\app\Administrator\oradata\orcl' scope=spfile;

alter system set log_file_name_convert='D:\app\Administrator\oradata\orcl','D:\app\Administrator\oradata\orcl' scope=spfile;

alter system set log_archive_format='%t_%s_%r.arc' scope=spfile;

alter system set standby_file_management=auto scope=spfile;
```



#### 2、修改listener.ora

```sql
# listener.ora Network Configuration File: D:\app\Administrator\product\11.2.0\dbhome_1\network\admin\listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =

  (SID_LIST =

    (SID_DESC =
    
      (GLOBAL_DBNAME = orcl)
    
      (ORACLE_HOME =D:\app\Administrator\product\11.2.0\dbhome_1)
    
      (SID_NAME = orcl)

   )

 )

LISTENER =

  (DESCRIPTION_LIST =

    (DESCRIPTION =
    
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.6.138)(PORT = 1521))
    
    )

  )

ADR_BASE_LISTENER = D:\app\Administrator
```



#### 3、修改tnsnames.ora

```sql
# tnsnames.ora Network Configuration File: D:\app\Administrator\product\11.2.0\dbhome_1\network\admin\tnsnames.ora

primary =

  (DESCRIPTION =

    (ADDRESS_LIST =
    
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.6.137)(PORT = 1521))
    
    )
    
    (CONNECT_DATA =
    
      (SERVICE_NAME = orcl)
    
    )

  )

standby =

  (DESCRIPTION =

    (ADDRESS_LIST =
    
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.6.138)(PORT = 1521))
    
    )
    
    (CONNECT_DATA =
    
      (SERVICE_NAME = orcl)
    
    )

  )

```

#### 4、密码文件和控制文件的创建传输

```sql

--windows密码文件路径： $ORACLE_HOME=D:\app\Administrator
D:\app\Administrator\product\11.2.0\dbhome_1\database\PWDorcl.ora
--linux密码文件路径：
$ORACLE_HOME/dbs/orapwSID

--(1)一般数据库默认就有密码文件，存放在$ORACLE_HOME/dbs/orapwSID  这里为orapworcl
--如果没有
orapwd file=$ORACLE_HOME/dbs/orapworcl password=oracle
--(2)检查REMOTE_LOGIN_PASSWORDFILE值是否为 EXCLUSIVE
show parameter REMOTE_LOGIN_PASSWORDFILE
 --如果值不是EXCLUSIVE，则：
 alter system set remote_login_passwordfile=exclusive scope=spfile;
--(3)密码文件需要scp到从库
--windows 手工拷贝
--linux  scp orapworcl oracle@192.168.6.138:/opt/oracle/11.2/dbs 提示输入yes 
--(4)控制文件：
--11g的控制文件一共两份，内容一样，一份在$ORACLE_BASE/oradata/orcl/control01.ctl
-- 一份在$ORACLE_BASE/flash_recovery_area/orcl/control02.ctl
 
-- 生成standby控制文件
 sql>shutdown immediate

sql>startup mount

sql>alter database create standby controlfile as 'D:\app\Administrator\oradata\orcl\standby_control01.ctl';

sql>startup open;

--windows 手工拷贝

--linux 然后在备库建立对应的目录,并授权
-- mkdir orcl--- chown oracle:oinstall(或dba) orcl
--  scp control01.ctl oracle@192.168.6.138:/opt/oracle/oradata/orcl
--  scp control02.ctl oracle@192.168.6.138:/opt/oracle/flash_recovery_area/orcl/

```

#### 5、创建从库库实例

```sql
5、注意（如果已经创建实例，则可以忽略）

如果从库没有创建数据库实例，需要创建下面对应的文件

D:\app\Administrator\admin\orcl\adump

D:\app\Administrator\admin\orcl\dpdump

D:\app\Administrator\admin\orcl\pfile

D:\app\Administrator\fast_recovery_area\orcl\

D:\app\Administrator\fast_recovery_area\orcl\ONLINELOG

D:\app\Administrator\oradata\orcl

--创建归档日志存放路径

D:\app\Administrator\archivelog

创建-SID

在cmd界面执行下面语句

oradim -new -sid ORCL

启动监听

lsnrctl start

```



#### 6、闪回数据库

```sql
 强烈建议开启数据库闪回功能。闪回允许你将数据库还原到以前的某一时间点。当发生故障转移时，这个功能非常有用，
      它能让你将老的主库闪回到故障前，然后将其转换为备库。如果没有启用闪回功能，你就必须重建备库，意味着要再复制一次数据文件。
      除了这个好处，闪回还能在某些情况下让你避免从备份恢复数据。

      (1)快速恢复区(Flash/Fast Recovery Area)，默认是配置的,但是需要确认这个区域的磁盘够大，至少300G以上（默认3G）
       sql>show parameter db_recovery_file_dest
       可以修改位置：sql>alter system set db_recovery_file_dest='新路径';
       更改大小：sql>alter system set db_recovery_file_dest_size=400G;

      (2)查看是否启用，默认是不开启的
       sql>select flashback_on from v$database;
       开启：sql>alter database flashback on;
       如果你碰到 ORA-01153 报错，那一定是在备库进行此操作。你需要先取消重做日志应用，启用闪回日志，然后重新启用日志应用。
       在主库启用闪回日志，不会同步备库也启用。你必须手动在主库和备库上均启用闪回日志。
       如果不启用闪回日志，当出现故障转移时，你将需要完全重新开始创建一个备库。


```



#### 7、复制数据库

```sql
shutdown immediate;

startup nomount;

通过rman复制数据库

在cmd界面执行

rman target sys/pass@primary auxiliary sys/pass@standby;

sys/pass@primary 主库

sys/pass@standby 从库

然后执行

RMAN> duplicate target database for standby nofilenamecheck from active database;

```



### 三、验证

#### 1、备库操作

```sql
启动数据库到只读状态

shutdown immediate;

startup mount;

alter database open read only;

开启自动同步

alter database recover managed standby database using current logfile disconnect from session;
```





#### 2、主库操作

```
select max(sequence#) from v$archived_log;
```



```
导入数据库
impdp REMAP_SCHEMA=jdzfgl_yn:yn_jdzfgl userid='yn_jdzfgl/pass@192.168.6.137/orcl' directory=DATA_PUMP_DIR dumpfile=jdzfgl_yn.DMP  logfile=jdzfgl_yn.log 


```

备1

```
SQL> select max(sequence#) from v$archived_log;
```



在主库创建表及新增数据

```
SQL> create table test(id number);

表已创建。

SQL> insert into test values(10);

已创建 1 行。

SQL> commit;

提交完成。

SQL> select * from test;
	
```

备库

```
SQL> select * from test;
	
```

#### 取消实时同步，在备库执行

```sql
 alter database recover managed standby database cancel; 
```





### 四、DGMGR 主备手动切换(switchover)



#### 1.取消实时同步

```sql
 alter database recover managed standby database cancel; 
```

#### 2.将主库切换为物理备库

```sql
STEP1：查看主库状态

SQL>  SELECT OPEN_MODE, DATABASE_ROLE, SWITCHOVER_STATUS, FORCE_LOGGING, DATAGUARD_BROKER, GUARD_STATUS FROM V$DATABASE;
 
OPEN_MODE            DATABASE_ROLE    SWITCHOVER_STATUS    FOR DATAGUAR GUARD_S
-------------------- ---------------- -------------------- --- -------- -------
READ WRITE           PRIMARY          SESSIONS ACTIVE      YES DISABLED NONE
注意：需要检查SWITCHOVER_STATUS参数，如果值为”SESSION ACTIVE”或者”TO STANDBY”, 则主数据库角色可以切换为备库角色。

STEP2：将其切换到备库，切换后，数据库会关闭

SQL> ALTER DATABASE COMMIT TO SWITCHOVER TO PHYSICAL STANDBY WITH SESSION SHUTDOWN;
注意：如果上一步的SWITCH_STATUS参数值为”TO STANDBY”，则 WITH SESSION SHUTDOWN 可以省略。

STEP3：启动到mount状态

SQL> SHUTDOWN ABORT
SQL> STARTUP MOUNT

注意：11.2.0.4版本及其以上版本不需要执行”SHUTDOWN ABORT”，因为数据库已经在STEP2命令中关闭了。

STEP4 只读打开数据库
alter database open read only;

STEP3：开启自动同步

alter database recover managed standby database using current logfile disconnect from session;

```

#### 2.将备库切换成主库并启动到open

```sql
STEP1：查看备库状态

SQL> SELECT OPEN_MODE, DATABASE_ROLE, SWITCHOVER_STATUS, FORCE_LOGGING, DATAGUARD_BROKER, GUARD_STATUS FROM V$DATABASE;
 
OPEN_MODE            DATABASE_ROLE    SWITCHOVER_STATUS    FOR DATAGUAR GUARD_S
-------------------- ---------------- -------------------- --- -------- -------
READ ONLY WITH APPLY PHYSICAL STANDBY TO PRIMARY           YES DISABLED NONE
注意：需要检查SWITCH_STATUS参数，如果值为”SESSION ACTIVE”或”TO PRIMARY”，则备库可以切换为主库。

STEP2先应用日志

ALTER  DATABASE RECOVER MANAGED STANDBY  DATABASE DISCONNECT FROM SESSION;

STEP3： 切换到主库

SQL> ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY WITH SESSION SHUTDOWN;
注意：如果上一步的SWITCH_STATUS参数值为”TO PRIMARY”，则 WITH SESSION SHUTDOWN 可以省略。

STEP4： 此时数据库为mount状态，需打开数据库

SQL> SELECT OPEN_MODE, DATABASE_ROLE, SWITCHOVER_STATUS, FORCE_LOGGING, DATAGUARD_BROKER, GUARD_STATUS FROM V$DATABASE;
 
OPEN_MODE            DATABASE_ROLE    SWITCHOVER_STATUS    FOR DATAGUAR GUARD_S
-------------------- ---------------- -------------------- --- -------- -------
MOUNTED              PRIMARY          NOT ALLOWED          YES DISABLED NONE
 
SQL> ALTER DATABASE OPEN ;
 
Database altered.
 
SQL>  SELECT OPEN_MODE, DATABASE_ROLE, SWITCHOVER_STATUS, FORCE_LOGGING, DATAGUARD_BROKER, GUARD_STATUS FROM V$DATABASE;
 
OPEN_MODE            DATABASE_ROLE    SWITCHOVER_STATUS    FOR DATAGUAR GUARD_S
-------------------- ---------------- -------------------- --- -------- -------
READ WRITE           PRIMARY          TO STANDBY           YES DISABLED NONE

```



### 五、dg 开机 、关机先后顺序

**关机顺序 先主机再备机，先实例后监听，这样日志就不会断了**

**开机顺序 先备机再主机 ，先监听后实例，这样的目标也是日志不断**

#### 1.关机

```sql
1.在主库上执行

shutdown immediate;

2.在备库上执行

alter database recover managed standby database cancel;–这句很关键，如果不执行这句，备库基本关不掉

shutdown immediate;
```

#### 2.开机

```
启动静态监听状态
lsnrctl start

检查监听状态
lsnrctl status

在备库上执行

–开MRP
启动数据库到只读状态

shutdown immediate;

startup mount;

alter database open read only;

开启自动同步

alter database recover managed standby database using current logfile disconnect from session;

在主库上执行

startup;
```

